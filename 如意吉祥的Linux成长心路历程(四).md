# 网络协议与管理
OSI模型：
---
1.物理层：二进制传输，为启动、维护以及关闭物理链路定义电气规范、机械规范、过程规范和功能规范  
2、数据链路层：定义如何格式化数据以便进行传输以及会如何控制对网络的访问、支持错误检测  
3.网络层：数据传输、路由数据包、选择船体数据最佳路径、支持逻辑选址和路径选择  
4.传输层：确保数据传输的可靠性、建立，维护 和终止模拟电路、通过错误检测和恢复、信息流控制来保证可靠性  
5.会话层：建立，管理和终止回话在应用之间的会话  
6.表示层：确保接收数据可以读出、格式化数据、构建数据、协商用于应用层的数据、提供加密  
7.应用层：提供应用程序协议  


PDU:协议数据单元对等的数据单位  
物理层数据单位：位bit  
数据链路层：帧frame  
网络层：数据包packct 逻辑地址，路由  
传输层：数据段setment 终端对终端通信，可靠  
更高层：message  

三种通讯方式：单播，组播，广播

双绞线：1，2脚：TX 3，6脚：RX


以太网结构：  
---
8前导信息  
6 目的  
6 源  
2 上层协议  
46-1500 数据（20个字节网络ip头 20字节传输层协议 应用字节）  
4 校验位FCS    

最小最大长度72-1526     60-1514数据报文  

抓包：tcpdump 捕获到达网卡的数据包  

CSMA/CD:冲突检测的载波帧听多路访问

hub集线器
共享带宽 
半双工 
不记忆MAC地址

冲突域：一个主机发送报文，另一主机也发送报文，产生冲突，两个主机在一个冲突域

广播域：一个主机发送报文，另一个主机收到，两个主机在一个广播域

以太网桥，交换机：  
1扩展了网络带宽  
2分割了网络冲突域，使网络冲突被限制在最小的范围内  
3交换机作为更加智能的交换设备，能够提供更多用户所要求的功能：优先级、虚拟网、远程检测……  

路由器  
---
分隔广播域  
选择路由表的路径  
维护和检查路由信息  
连接广域网  

集线器工作在物理层 交换机在数据链路层 路由器网络层 网卡在数据链路层

VLAN
分隔广播域 安全 灵活管理  vlan=广播域=逻辑网络


广播风暴=网络回环   STP生成树协议避免回环  主动断开某一个端口


TCP/IP协议栈
包括：TCP、IP、UDP、ICMP、RIP、TELNET、SMTP、ARP等等

应用层{应用 表示 会话 } 传输层
Internet层  网络访问层{数据链路层，物理层}

应用层协议：FTP、TFTP、nfs smtp、dns、http。。。。

传输层：upd tcp 
tcp与udp表象区别：
t面向连接u不面向连接
t序列化u没有序列化，表示是否有顺序
使用场合t邮件，文件共享，下载等 u视频音频


## TCP包头：20字节 每行32位  
```
第一部分：16位源端口 16位目的端口 | 2^16次方=65535     
http tcp80   
ssh tcp22   
ftp tcp21   
telnet tcp23  
kerberos tcp88  
stmp tcp25  
pop3 tcp110  
imap  tcp143  
qq udp8000  
https tcp443   
dns tcp和udp53    
dhcp tcp67 ，68    
snmp UDP161   
mysq tcpl3306    
oracle tcp1521    
sqlserver1533  
TFTP udp69  

/etc/services查看软件对应端口号  
ip_local_port_range端口号范围


第二部分：序列号和确认号

第三部分：
数据偏移：报文头部长度  
保留  
六个位：URG紧急指针位  
       ACK确认位要么0或1
       PSH 立即传还是一会传为1立刻从缓存读取   
       RST reset =1表示与主机连接出现错误建立从连
       SYN建立连接时，同步序号；当SYN=1，ACK=0时，表示这是一个请求建立连接的报文段；当SYN=1，ACK=1时，表示对方同意建立连接
       FIN表示通知对方本端要关闭连接了，标记数据是否发送完毕

```
TCP三次握手：发送数据报文SYN=1，报文序号seq=x；服务器端收到立即回应SYN=1，ACK=1，并产生自己序号seq=y和接收的确认号ack=x+1（表明自己收到了seq报文，并要求对方发送seq+1）；客户端回应ACK=1，确认服务器端请求发送seq=X+1和ack=y+1

三次握手的网络状态：closed--->SYN-SENT--->ESTAB-LISTENED  
                  closed--->SYN-RCVD--->ESTAB-LISTENED


TCP四次挥手:客户端发送FIN=1的报文表示请求结束会话，生成seq=u；服务端确认分手包ACK=1，生成自己编号seq=w，ack=u+1;服务器端可能发送之前为传完的数据，传完后发送FIN，ACK，序号并要求客户端发送u+1确认；客户端收到服务器端的报文，立刻回应seq=u+1包，ACK=1,ack=w+1结束双方的会话

四次挥手网络状态：  
```
ESTAB-LISTENED-->FIN-WAIT 1--->FIN-WAIT 2--->TIME-WAIT--->CLOSED  
ESTAB-LISTENED--->CLOSE-WAIT--->LAST-ACK--->CLOSED  
```

sync半连接和accept全连接：等待连接的队列，全部连接的队列
/proc/sys/net/ipv4/tcp_max_syn_backlog 未完成连接队列大小，建议调整大小为1024以上
/proc/sys/net/core/somaxconn完成连接队列大小，建议调整大小为1024以上

```
 ss -nt |sed -nr '1!s/^[^ ]+ .*/\1/p' |sort |uniq -c 查看网络中连接状态并统计次数
```
tcp包头窗口：表示现在允许对方发送的数据量 


UDP协议
包头：16位源端口，16位目标端口，16位长度，16位错误检测，其他data部分

Internet层：
IP协议
ICMP协议：网络控制信息协议，检测网络是否正常。例如：ping命令
ARP协议：地址解析协议，广播通讯记录ip与mac的对应关系

IP PDU报头：
```
1.版本：  0-3位  IPv4

2.首部长度：确定长度

3.区分服务:占8位,用来获得更好的服务,在旧标准中叫做服务类型,但实际上一直未被使用过.后改名为区分服务.只有在使用区分服务(DiffServ)时,这个字段才起作用.一般的情况下不使用

4.总长度：ip报文总长

5.标识： 来自哪个段

6.标志：3位二进制 当前报文时是否被切割 是不是整个大段的最后

7.片偏移：来自大段切割的第几个段

8.生存时长：最大通过的路由数量

9.协议：提供上层的协议的类型

10.首部校验和：算数据报文的计算，收到后跑到对端检查

11源地址

12目标地址

13可选字段

14填充

15数据部分
```

# 网络地址：  
```
A  
1-126.X.Y.Z  
网络ID位为高8位，主机ID位为24  
0xxxxxxx.X.Y.Z  
00000000 0  
01111111 127  
最大主机数：1600万  
网络数：12  
B  
128-191.x.y.z  
网络ID位为高16位，主机ID位为16  
10xxxxxx.X.Y.Z  
10000000. 128  
10111111. 191  
最大主机数：65534  
网络数：2^16  
C  
192-223.x.y.z  
网络ID位为高24位，主机ID位为8  
110xxxxx.x.y.z  
11000000 192  
11011111 223  
最大主机数：254  
网络数2^24  

D  
224-239.x.y.z  
多播地址  
1110xxxx.x.y.z  

E  
11110xxx.  
240-254.x.y.z  


1一个网络中主机最大数=2^主机ID位数(32-网络ID位数)-2=2^(32-网络ID位数)-2  
2网络数=2^可变网络ID位  
3CIDR表示法：IP/网络ID位数  
4网络ID值=IP与子网掩码  
5划分子网：一个大网划分成多个小网，网络ID位变多，主机ID位才变少，网络ID向主机ID借位N,分成2^N个小网  
6合并超网：多个小网合并成一个大网，主机ID向网络ID借位  
 

私有地址：10.0.0.0---10.255.255.255  
          172.16.0.0---172.31.255.255  
          192.168.0.0---192.168.255.255  

0.0.0.0网卡初始地址  
255.255.255.255广播地址  
127.0.0.1---127.255.255.254回环地址  
224.0.0.0---239.255.255.255组播地址  
169.254.X.X无法从DHCP中获取地址，系统会自动分配这特殊地址  

保留地址：  
后全0 该网络网络地址  
后全1 该网广播地址络  
```
检查是否在一个网段：用对方ip地址与本机的子网掩码做“与”运算  
路由：跨网络通信 路径 route -n查看路由表  
路由表：目标ip所在网络ID  
网关：需要将报文发送给下一个路口的接口对应的IP  

RIP:经过路由器数量最少  
OSPF：考虑带宽高的线路  